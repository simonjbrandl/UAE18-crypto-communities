---
title: "UAE18 crypto communities"
author: "Simon J Brandl"
date: "11/22/2018"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r SETUP, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r LOAD PACKAGES}
#load packages
library(plyr)
library(dplyr)
library(tidyverse)
library(vegan)
library(nlme)
library(lme4)
library(ggpubr)
library(ggrepel)
library(colorRamps)
library(tidybayes)
library(brms)
library(fishualize)
library(modelr)
library(beepr)
library(png)
library(grid)
```

```{r LOAD DATASETS AND SILHOUETTES}
#load datasets
comms <- read.csv(file = "Data/UAE18_RawData_Comms.csv")
ctdat <- read.csv(file = "Data/UAE_CT.csv")
comms$Genspe <- paste(substr(comms$Genus, 0,3), comms$Species, sep = ". ")
ctdat$Genspe <- paste(substr(ctdat$Genus, 0,3), ctdat$Species, sep = ". ")
ctdat <- ctdat %>% mutate(Distribution = case_when(Tax == "ECSEPULC" ~ "AG+GoM",
                                         Tax == "CORYANOM" ~ "AG+GoM",
                                         Tax == "ENNEVENT" ~ "AG+GoM",
                                         Tax == "HELCFUSC" ~ "GoM",
                                         Tax == "HETEVULG" ~ "GoM",
                                         Tax == "EVIOGUTT" ~ "GoM"))
ctmax <- subset(ctdat, ctdat$Ctmax != "NA")
ctmin <- subset(ctdat, ctdat$Ctmin != "NA")

# silhouettes for study species
img <- readPNG("Plots/Canomalus.png")
canom <- rasterGrob(img, interpolate=TRUE)

img <- readPNG("Plots/Epulcher.png")
epulc <- rasterGrob(img, interpolate=TRUE)

img <- readPNG("Plots/Eventermaculus.png")
event <- rasterGrob(img, interpolate=TRUE)

img <- readPNG("Plots/Hvulgaris.png")
hvulg <- rasterGrob(img, interpolate=TRUE)

img <- readPNG("Plots/Eguttata.png")
egutt<- rasterGrob(img, interpolate=TRUE)

img <- readPNG("Plots/Hfuscopinna.png")
hfusc <- rasterGrob(img, interpolate=TRUE)

```

```{r COMMUNITY STRUCTURE: ABUNDANCE, BIOMASS, DIVERSITY}
#start with community analyses
# 1. compare abundance, biomass, diversity
# 2. compare community composition
# calculate surface area for each bommie 
# radius first (2*curved surface length/2*pi)
comms$radius <- (2*comms$Dimension)/(2*pi)
# surface area (4*pi*radius^2)/2 and divide by 10000 for square meters
comms$SA <- ((4*pi*comms$radius^2)/2)/10000

###get biomass and diversity estimates for Arabian Gulf and Gulf of Oman
comm_means <- comms %>% group_by(Location, Site, Sitename, Sitenumber) %>% summarize(Biomass = sum(W), Abundance = n(), Speciesrichness = length(unique(Genspe)), SA = mean(SA)) %>%
  mutate(Density = Abundance/SA,
         Biomass_per_m2 = Biomass/SA,
         Species_density = Speciesrichness/SA,
         site_intercepts = case_when(Site == "Dhabiya" ~ 1.90,
                                     Site == "RasGhanada" ~ 1.80,
                                     Site == "Saadiyat" ~ 1.70,
                                     Site == "Dibba" ~ 0.9,
                                     Site == "SharmRock" ~ 0.80,
                                     Site == "Snoopy" ~ 0.70),
         site_reord = factor(Site, levels = sort(levels(site_intercepts))))


#run GLM with abundance data and offset for surface area sampled
abundance.model <- brm(log(Density) ~ Location + (1|Site), 
                            data = comm_means, control = list(adapt_delta = 0.999, max_treedepth = 15))
summary(abundance.model)
abu.pred <- comm_means %>%
  data_grid(Location) %>%
  add_predicted_draws(abundance.model, n = 1000) %>%
  mutate(pred.density = exp(.prediction))


abu.pred.plot <- ggplot(data = abu.pred) +
  geom_halfeyeh(aes(y = rev(Location), x = pred.density, fill = Location)) +
  geom_jitter(aes(x = Density, y = site_intercepts, shape = reorder(Site, sort(as.numeric(site_intercepts))), fill = Location), color = "black", 
             data = comm_means, height = 0.02, 
             alpha = 0.5, size = 2) +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_fill_manual(values = alpha(c("dodgerblue4", "mediumaquamarine"), 0.5)) +
  scale_shape_manual(name = "Site", values = c(21,22,23,21,22,23)) +
  scale_x_log10(limits = c(0.1,5e2), breaks=c(0,0.1,1,10,100), labels=c(0,0.1,1,10,100)) +
  theme_bw() +
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  guides(fill = guide_legend(nrow = 1),
         shape = guide_legend(nrow = 1)) +
  xlab(expression(paste("Density of cryptobenthic fishes (individuals ", m^{-2},")")))
abu.pred.plot

ggsave("Plots/abupred.pdf", abu.pred.plot, width = 8, height = 4, useDingbats = F)


###############biomass

#run GLM with abundance data and offset for surface area sampled
biomass.model <- brm(log(Biomass_per_m2) ~ Location + (1|Site), 
                            data = comm_means, 
                     control = list(adapt_delta = 0.9999, max_treedepth = 15))
summary(biomass.model)
bio.pred <- comm_means %>%
  data_grid(Location) %>%
  add_predicted_draws(biomass.model, n = 1000) %>%
  mutate(pred.biomass = exp(.prediction))


bio.pred.plot <- ggplot(data = bio.pred) +
  geom_halfeyeh(aes(y = rev(Location), x = pred.biomass, fill = Location)) +
  geom_jitter(aes(x = Biomass_per_m2, y = site_intercepts, shape = reorder(Site, sort(as.numeric(site_intercepts))), fill = Location), color = "black", 
             data = comm_means, height = 0.02, 
             alpha = 0.5, size = 2) +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_fill_manual(values = alpha(c("dodgerblue4", "mediumaquamarine"), 0.5)) +
  scale_shape_manual(name = "Site", values = c(21,22,23,21,22,23)) +
  scale_x_log10(limits = c(0.1,1e3), breaks=c(0,0.1,1,10,1000), labels=c(0,0.1,1,10,1000)) +
  theme_bw() +
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  guides(fill = guide_legend(nrow = 1),
         shape = guide_legend(nrow = 1)) +
  xlab(expression(paste("Biomass of cryptobenthic fishes (grams ", m^{-2},")")))
bio.pred.plot

ggsave("Plots/biopred.pdf", bio.pred.plot, width = 8, height = 4, useDingbats = F)


###############biomass

#run GLM with abundance data and offset for surface area sampled
diversity.model <- brm(log(Species_density) ~ Location + (1|Site), 
                            data = comm_means,
                     control = list(adapt_delta = 0.999, max_treedepth = 15))
summary(diversity.model)
div.pred <- comm_means %>%
  data_grid(Location) %>%
  add_predicted_draws(diversity.model, n = 1000) %>%
  mutate(pred.diversity = exp(.prediction))


div.pred.plot <- ggplot(data = div.pred) +
  geom_halfeyeh(aes(y = rev(Location), x = pred.diversity, fill = Location)) +
  geom_jitter(aes(x = Species_density, y = site_intercepts, shape = reorder(Site, sort(as.numeric(site_intercepts))), fill = Location), color = "black", 
             data = comm_means, height = 0.02, 
             alpha = 0.5, size = 2) +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_fill_manual(values = alpha(c("dodgerblue4", "mediumaquamarine"), 0.5)) +
  scale_shape_manual(name = "Site", values = c(21,22,23,21,22,23)) +
  scale_x_log10(limits = c(0.1,100), breaks=c(0,0.1,1,10,100), labels=c(0,0.1,1,10,100)) +
  theme_bw() +
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "top") +
  guides(fill = guide_legend(nrow = 1),
         shape = guide_legend(nrow = 1)) +
  xlab(expression(paste("Species richness of cryptobenthic fishes (species ", m^{-2},")")))
div.pred.plot

ggsave("Plots/divpred.pdf", div.pred.plot, width = 8, height = 4, useDingbats = F)

Fig1 <- ggarrange(div.pred.plot, abu.pred.plot, bio.pred.plot, nrow = 3)

ggsave("Plots/Fig1ABC.pdf", Fig1, width = 8, height = 12, useDingbats = F)
```

```{r COMMUNITY COMPOSITION NMDS}
comms$count = 1
comms_wide <- comms %>% 
  group_by(Location, Site, Sitenumber, Genspe) %>%
  summarize(totaln = sum(count)) %>%
  spread(Genspe, totaln, fill = 0) 

###run MDS
comp_mds <- metaMDS(comms_wide[-c(1:3)], metric = "bray", trymax = 1000)
comp_mds
###get values and plot in ggplot
site.scores <- as.tibble(scores(comp_mds)) %>%
  mutate(Location = comms_wide$Location,
         Site = comms_wide$Site,
         Sitenumber = comms_wide$Sitenumber) %>% 
  inner_join(comm_means)



mds.points <- as.data.frame(scores(comp_mds, "species")) %>%
  add_column(Genspe = rownames(.))

genspeabu <- comms %>%
  group_by(Genspe, Family) %>%
  summarize(count = n()) %>%
  inner_join(mds.points)

point.plot <- ggplot(genspeabu) +
  theme_bw() +
  geom_segment(aes(x=0, xend=NMDS1, y=0, yend=NMDS2, color = Family),
               arrow = arrow(length = unit(0.1, "cm")),
               inherit.aes = F) +
  geom_text_repel(aes(x=NMDS1, NMDS2, label=Genspe), size=2, inherit.aes = F) +
  scale_color_fish(discrete=TRUE, option = "Valenciennea_strigata")
point.plot
###create convex hulls function
convex_hull <- function(site.scores) site.scores[chull(site.scores$NMDS1, site.scores$NMDS2),] 

###run convex hulls on habitats
location_hulls <- ddply(site.scores, "Location", convex_hull)


###create vector with habitat names in center of convex hulls
location_centers <- location_hulls %>% group_by(Location) %>% summarize(NMDS1 = mean(NMDS1), NMDS2 = mean(NMDS2))

###plot mds results
# plot one species name
comp_plot <- ggplot(site.scores, aes(x = NMDS1, y = NMDS2)) +
  #overlay convex hulls
  geom_polygon(data = location_hulls, aes(x = NMDS1, y = NMDS2, 
                                         fill = Location, 
                                         group = Location), 
               alpha = 0.4, lty = 1, lwd = 0.1, color = "black") +
  #overlay points
  geom_point(aes(color = Location, group = Location, fill = Location,
                             shape = reorder(Site, sort(as.numeric(site_intercepts))))) +
  theme_bw()+
  theme(legend.position = "right") +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_fill_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_shape_manual(name = "Site", values = c(21,22,23,21,22,23)) +
    guides(fill = guide_legend(ncol = 1),
         shape = guide_legend(ncol = 1))

comp_plot
ggsave("Plots/comp_plot.pdf", plot = comp_plot, width = 8, height = 6, useDingbats=FALSE)
```

```{r SIZE: E. ventermaculis and C. anomalus}
table(comms$Tax, comms$Location)
size.strs.event <- comms %>%
  filter(Tax %in% c("ENNEVENT")) 

size.model.event <- brm(W ~ (TL + Location), data = size.strs.event, family = Gamma(link = "log"))
summary(size.model.event)

size.preds.event <- size.strs.event %>%
  group_by(Location) %>%  
  data_grid(TL = seq_range(TL, n = 100)) %>%
  add_fitted_draws(size.model.event, n = 500)

event.plot <- ggplot(size.preds.event, aes(x = TL, y = W, color = ordered(Location))) +
  geom_line(aes(y = .value, group = paste(Location, .draw)), alpha = .3, lwd = 0.1) +
  geom_point(data = size.strs.event, aes(fill = Location), alpha = 0.5, size = 0.8, shape = 23, color = "black") +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_fill_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  ylab("body weight in g") +
  xlab("total length (TL) in mm") +
  theme_bw() +
  theme(legend.position = "none")
event.plot
size.strs.canom <- comms %>%
  filter(Tax %in% c("CORYANOM")) 

size.model.canom <- brm(W ~ (TL + Location), data = size.strs.canom, family = Gamma(link = "log"))
summary(size.model.canom)

size.preds.canom <- size.strs.canom %>%
  group_by(Location) %>%  
  data_grid(TL = seq_range(TL, n = 100)) %>%
  add_fitted_draws(size.model.canom, n = 500)

canom.plot <- ggplot(size.preds.canom, aes(x = TL, y = W, color = ordered(Location))) +
  geom_line(aes(y = .value, group = paste(Location, .draw)), alpha = .3, lwd = 0.1) +
  geom_point(data = size.strs.canom, aes(fill = Location), size = 0.8, alpha = 0.5, shape = 23, color = "black") +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  scale_fill_manual(values = c("dodgerblue4", "mediumaquamarine")) +
  ylab("body weight in g") +
  xlab("total length (TL) in mm") +
  theme_bw() +
  theme(legend.position = "none")
canom.plot
Fig3 <- ggarrange(event.plot, canom.plot, ncol = 1, nrow = 2)
ggsave("Plots/Fig3.pdf", Fig3, width = 4, height = 7, useDingbats = F)
###comp abundance of three species in AG & GoO
```

```{r PHYSIOLOGY: CTmax and CTmin}
# ct max and ctmin
ctmax <- ctmax %>%
    mutate(ordervar = case_when(Tax == "CORYANOM" ~ 6,
                              Tax == "ECSEPULC" ~ 5,
                              Tax == "ENNEVENT" ~ 4,
                              Tax == "HETEVULG" ~ 3,
                              Tax == "EVIOGUTT" ~ 2,
                              TRUE ~ 1),
           taxloc = factor(interaction(Tax, Location)))

table(ctmax$taxloc)

maxmod <- brm(Ctmax ~ taxloc, data = ctmax,  control = list(adapt_delta = 0.995, max_treedepth = 18), iter = 5000);beep(sound = "coin")
summary(maxmod)

ctmax.pred <- ctmax %>%
  data_grid(taxloc)%>%  
  add_predicted_draws(maxmod, n = 10000) %>%
  separate(taxloc, c("Tax", "Location"), remove = F) %>%
  mutate(ordervar = case_when(Tax == "CORYANOM" ~ 6,
                              Tax == "ECSEPULC" ~ 5,
                              Tax == "ENNEVENT" ~ 4,
                              Tax == "HETEVULG" ~ 3,
                              Tax == "EVIOGUTT" ~ 2,
                              TRUE ~ 1))

ctmax.pred.plot <- ggplot(data = ctmax.pred) +
  geom_halfeyeh(aes(y = ordervar, x = .prediction, fill = Location))+
  geom_point(aes(x = Ctmax, y = ordervar, shape = Tax, fill = Location),
             data = ctmax, position = position_nudge(y = 0.45), size = 2, color = "black", shape = 23) +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine"), labels = c("Arabian Gulf", "Gulf of Oman")) +
  scale_fill_manual(values = alpha(c("dodgerblue4", "mediumaquamarine"), 0.9), labels = c("Arabian Gulf", "Gulf of Oman")) +
  scale_shape_manual(values = c(8, 21:25)) +
    theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        legend.position = "top") +
  guides(fill = guide_legend(nrow = 1),
         shape = guide_legend(nrow = 1)) +
  xlab("Critical thermal maximum (º Celsius)") +
  scale_x_continuous(limits = c(34,41), breaks = seq(34,41,1)) +
  annotation_custom(canom, xmin=33.75, xmax=35.25, ymin=6, ymax=7) +
  annotation_custom(epulc, xmin=33.75, xmax=35.25, ymin=5, ymax=6) +
  annotation_custom(event, xmin=33.75, xmax=35.25, ymin=4, ymax=5) +
  annotation_custom(hvulg, xmin=33.75, xmax=35.25, ymin=3, ymax=4) +
  annotation_custom(egutt, xmin=33.75, xmax=35.25, ymin=2, ymax=3) +
  annotation_custom(hfusc, xmin=33.75, xmax=35.25, ymin=1, ymax=2) +
  annotate("text", x = 34.5, y = 6.15, 
            label = 'italic("C. anomalus")', size = 3.5, parse = TRUE) +
    annotate("text", x = 34.5, y = 5.15, 
            label = 'italic("E. pulcher")', size = 3.5, parse = TRUE) +
    annotate("text", x = 34.5, y = 4.15, 
            label = 'italic("E. ventermaculus")', size = 3.5, parse = TRUE) +
    annotate("text", x = 34.5, y = 3.15, 
            label = 'italic("H. vulgaris")', size = 3.5, parse = TRUE) +
    annotate("text", x = 34.5, y = 2.15, 
            label = 'italic("E. guttata")', size = 3.5, parse = TRUE) +
    annotate("text", x = 34.5, y = 1.15, 
            label = 'italic("H. fuscopinna")', size = 3.5, parse = TRUE) +
    annotate("text", x = 9.5, y = 7, size = 5, label = "(a)")
  
ctmax.pred.plot




####ctmin

ctmin <- ctmin %>%
    mutate(ordervar = case_when(Tax == "CORYANOM" ~ 6,
                              Tax == "ECSEPULC" ~ 5,
                              Tax == "ENNEVENT" ~ 4,
                              Tax == "HETEVULG" ~ 3,
                              Tax == "EVIOGUTT" ~ 2,
                              TRUE ~ 1),
           taxloc = factor(interaction(Tax, Location)))

table(ctmin$taxloc)

minmod <- brm(Ctmin ~ taxloc, data = ctmin,  control = list(adapt_delta = 0.995, max_treedepth = 18), iter = 5000);beep(sound = "coin")
summary(minmod)

ctmin.pred <- ctmin %>%
  data_grid(taxloc)%>%  
  add_predicted_draws(minmod, n = 10000) %>%
  separate(taxloc, c("Tax", "Location"), remove = F) %>%
  mutate(ordervar = case_when(Tax == "CORYANOM" ~ 6,
                              Tax == "ECSEPULC" ~ 5,
                              Tax == "ENNEVENT" ~ 4,
                              Tax == "HETEVULG" ~ 3,
                              Tax == "EVIOGUTT" ~ 2,
                              TRUE ~ 1))

ctmin.pred.plot <- ggplot(data = ctmin.pred) +
  geom_halfeyeh(aes(y = ordervar, x = .prediction, fill = Location))+
  geom_point(aes(x = Ctmin, y = ordervar, shape = Tax, fill = Location),
             data = ctmin, position = position_nudge(y = 0.45), size = 2, color = "black", shape = 23) +
  scale_color_manual(values = c("dodgerblue4", "mediumaquamarine"), labels = c("Arabian Gulf", "Gulf of Oman")) +
  scale_fill_manual(values = alpha(c("dodgerblue4", "mediumaquamarine"), 0.9), labels = c("Arabian Gulf", "Gulf of Oman")) +
    theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        legend.position = "top") +
  guides(fill = guide_legend(nrow = 1),
         shape = guide_legend(nrow = 1)) +
  xlab("Critical thermal minimum (º Celsius)") +
  scale_x_continuous(limits = c(9.5,16.5), breaks = seq(9,16.5,1)) +
  annotation_custom(canom, xmin=15.25, xmax=16.75, ymin=6, ymax=7) +
  annotation_custom(epulc, xmin=15.25, xmax=16.75, ymin=5, ymax=6) +
  annotation_custom(event, xmin=15.25, xmax=16.75, ymin=4, ymax=5) +
  annotation_custom(hvulg, xmin=15.25, xmax=16.75, ymin=3, ymax=4) +
  annotation_custom(egutt, xmin=15.25, xmax=16.75, ymin=2, ymax=3) +
  annotation_custom(hfusc, xmin=15.25, xmax=16.75, ymin=1, ymax=2) +
  annotate("text", x = 16, y = 6.15, 
            label = 'italic("C. anomalus")', size = 3.5, parse = TRUE) +
    annotate("text", x = 16, y = 5.15, 
            label = 'italic("E. pulcher")', size = 3.5, parse = TRUE) +
    annotate("text", x = 16, y = 4.15, 
            label = 'italic("E. ventermaculus")', size = 3.5, parse = TRUE) +
    annotate("text", x = 16, y = 3.15, 
            label = 'italic("H. vulgaris")', size = 3.5, parse = TRUE) +
    annotate("text", x = 16, y = 2.15, 
            label = 'italic("E. guttata")', size = 3.5, parse = TRUE) +
    annotate("text", x = 16, y = 1.15, 
            label = 'italic("H. fuscopinna")', size = 3.5, parse = TRUE) +
    annotate("text", x = 9.5, y = 7, size = 5, label = "(a)")
  
ctmin.pred.plot

#function for legend
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend<-g_legend(ctmin.pred.plot)

ctplots <- gbm::grid.arrange( mylegend, gridExtra::arrangeGrob(ctmin.pred.plot + theme(legend.position="none"),
                         ctmax.pred.plot + theme(legend.position="none"),
                         nrow=1),
            nrow=2, heights=c(1, 12))

ggsave("Plots/ct_plot.pdf", plot = ctplots, width = 10, height = 9, useDingbats=FALSE)
```

``` {r}
# map of study region

####FIGURE 1B####
library(ggmap)

world <- map_data("world")
world_sub <- subset(world, world$long >= 50 & world$long <= 60 & world$lat >= 20 & world$lat <= 30)

country_names <- world_sub %>% group_by(region) %>% summarize(lat = mean(lat), long = mean(long))

UAEcoord <- comms[c(2,3,20,21)]
UAEcoord_unique <- unique(UAEcoord)

middle.east <- ggplot() +
  geom_map(data = world_sub, map = world, aes(x = long, y = lat, map_id = region), fill = "grey69", color = "grey46", lwd = 0.1) +
  geom_point(data = UAEcoord_unique, aes(x = long, y = Lat, color = Location), size = 3, alpha = 1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  annotate("text", label = "United Arab Emirates", x = 54, y = 23.5, size = 3, colour = "black") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east
ggsave("middle_east.pdf", plot = middle.east, width = 6, height = 5, useDingbats=FALSE)

UAElarge <- subset(world, world$long >= -10 & world$long <= 120 & world$lat >= 0 & world$lat <= 70)

middle.east.large <- ggplot() +
  geom_map(data = UAElarge, map = world, aes(x = long, y = lat, map_id = region), fill = "grey92", color = "grey46", lwd = 0.1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east.large
ggsave("middle_east_large.pdf", plot = middle.east.large, width = 6, height = 4, useDingbats=FALSE)


UAEmid <- subset(world, world$long >= 30 & world$long <= 80 & world$lat >= 10 & world$lat <= 40)

middle.east.mid <- ggplot() +
  geom_map(data = UAEmid, map = world, aes(x = long, y = lat, map_id = region), fill = "grey92", color = "grey46", lwd = 0.1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east.mid
ggsave("middle_east_large.pdf", plot = middle.east.large, width = 6, height = 4, useDingbats=FALSE)

america <- subset(world, world$region == "United States of America" & world$region == "Canada")

middle.east.mid <- ggplot() +
  geom_map(data = UAEmid, map = world, aes(x = long, y = lat, map_id = region), fill = "grey92", color = "grey46", lwd = 0.1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east.mid
```

```{r}
### gut content metabarcoding data
detach("package:MASS", unload=TRUE)
guts.meta <- read.csv(file = "UAE_Metabarcoding.csv")
coi.seqs <- read.csv(file = "UAE_COI.csv") %>%
  select(-c(UAE18862.1, UAE18400.1)) %>%
  filter(!species %in% c("Coryogalops anomolus", 
                         "Neopomacentrus miryae", 
                         "Ecsenius pulcher", 
                         "Belonidae sp. BOLD:AAE0217", 
                         "Eviota guttata", 
                         "Etheostoma flabellare", 
                         "Homo sapiens", 
                         "Butis gymnopomus",
                         "Dinematichthys iluocoeteoides",
                         "Oncorhynchus nerka"))
#create vector for column names 
cnames <- as.character(coi.seqs$ID)
coi.sub <- coi.seqs[c(19:104)]%>%
  #grab columns of fish gut specimens
  rownames_to_column %>% 
  gather(var, value, -rowname) %>% 
  spread(rowname, value) %>%
  set_colnames(c("ID.match", cnames)) %>%
  join(guts.meta[c("Location", "Tax", "ID.match")], by = "ID.match") %>%
  select(ID.match, Location, Tax, everything()) %>% 
  mutate(rowsum = rowSums(.[4:552])) %>%
  filter(rowsum >= 1)

coi.sub.tax <- coi.sub %>%
  filter(Tax %in% c("ENNEVENT", "CORYANOM", "ECSEPULC"))

# coi.rra <- coi.sub.tax %>%
#   select(-c(Location, Tax)) %>%
#   gather(variable, value, -ID.match) %>%
#   group_by(ID.match) %>% 
#   mutate(percentage = value/sum(value)) %>% 
#   select(-value) %>% 
#   spread(variable, percentage)



coi.pa <- coi.sub.tax %>%
  select(-c(ID.match, Location, Tax)) %>%
  mutate_all(funs(case_when(. > 0 ~ 1,
                       TRUE ~ 0))) %>%
  add_column(ID.match = coi.sub.tax$ID.match) %>%
  select(ID.match, everything())

### run mds
coi_mds <- metaMDS(coi.pa[-1], k = 3, trymax = 1000, distance = "jaccard", engine = "monoMDS", autotransform =TRUE)
coi_mds

###get values and plot in ggplot
coi.scores <- as.tibble(coi_mds$points)
coi.scores$tax <- coi.sub.tax$Tax
coi.scores$location <- coi.sub.tax$Location
coi.scores$ID.match <- coi.sub.tax$ID.match

coi.scores1 <- coi.scores %>%
  unite("taxloc", c(tax, location), remove = F)

###do permanova
coi.pa.perm <- adonis(coi.pa[-1] ~ location * tax, data = coi.scores1)
coi.pa.perm


###do simper
coi.pa.sim <- as.list(simper(coi.pa[-1], coi.scores1$taxloc))
simsum <- summary(coi.pa.sim)
top3<-lapply(simsum, `[`,1:3,)
otunames <- ldply(lapply(top3, rownames)) %>%
  gather("comparison", "ID", V1, V2, V3) %>%
  arrange(.id)

top3long <- plyr::ldply(top3, data.frame) %>%
  arrange(.id) %>%
  select(.id) %>%
  add_column(ID = otunames$ID)

OTUcoords <- as.data.frame(coi_mds$species) %>%
  add_column(ID = rownames(.))

OTUtax <- coi.seqs[c(1:10)]

top3coords <- top3long %>%
  left_join(OTUcoords, by = "ID") %>%
  left_join(OTUtax, by = "ID") %>%
  mutate(taxID = case_when(pident >= 97 ~ paste(phylum, class, order, species, sep = " | "),
                           pident >= 95 ~ paste(phylum, class, order, sep = " | "),
                           pident >= 85 ~ paste(phylum, class, sep = " | "),
                           pident >= 75 ~ paste(phylum),
                           pident < 75 ~ "Unidentified")) %>%
  mutate(oMDS1 = 0,
         oMDS2 = 0) %>%
  select(-.id) %>%
  unique(.)

# 4 is Arthropoda | Insecta (Tantytarsus)
# 6 is also Arthropoda | Insecta (Tantytarsus)
# 12 is also Arthropoda | Insecta (Tantytarsus)
###create convex hulls function
convex_hull <- function(coi.scores1) coi.scores1[chull(coi.scores1$MDS1, coi.scores1$MDS2),] 

###run convex hulls on habitats
fish_hulls <- ddply(coi.scores1, "taxloc", convex_hull)

# ### set colors
taxloccols <- c("olivedrab4", "olivedrab2", "cyan4", "cyan2", "darkorchid4", "darkorchid2")

###plot mds results
# plot one species name
mds.pa.coi.loc <- ggplot(coi.scores1, aes(x = MDS1, y = MDS2)) +
  #overlay convex hulls
  geom_polygon(data = fish_hulls, aes(x = MDS1, y = MDS2,
                                         color = taxloc,
                                         group = taxloc), fill = "grey69",
               alpha = 0.1, lty = 1, lwd = 0.1) +
  # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
  #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
  #overlay point
  geom_point(size = 2, aes(color = taxloc, group = taxloc, shape = location)) +
  theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") +
  scale_y_continuous(limits = c(-1.4,1.1), breaks = seq(-1,1,0.5)) +
  scale_x_continuous(limits = c(-1.1,1.6), breaks = seq(-1,1,0.5)) +
  scale_color_manual(values = taxloccols) +
  scale_fill_manual(values = taxloccols)

mds.pa.coi.loc

mds.top3.coi.loc <- ggplot(top3coords, aes(x = MDS1, y = MDS2)) +
  geom_segment(data = top3coords, mapping = aes(xend = oMDS1, yend = oMDS2), lwd = 0.2, lty = 2) +
  geom_point(size = 3, shape = 18) +
    geom_label_repel(aes(label = taxID), size = 2) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") +
    scale_y_continuous(limits = c(-1.4,1.1), breaks = seq(-1,1,0.5)) +
  scale_x_continuous(limits = c(-1.1,1.6), breaks = seq(-1,1,0.5)) 
mds.top3.coi.loc

mds.coi.loc.vec <- ggarrange(mds.pa.coi.loc, mds.top3.coi.loc, ncol = 1, nrow = 2)

ggsave("mds.pa.coi.loc.pdf", mds.coi.loc.vec, width = 7, height = 10, useDingbats = FALSE)

### bring in other taxa
coi.sub.taxloc <- coi.sub

# coi.rra <- coi.sub.tax %>%
#   select(-c(Location, Tax)) %>%
#   gather(variable, value, -ID.match) %>%
#   group_by(ID.match) %>% 
#   mutate(percentage = value/sum(value)) %>% 
#   select(-value) %>% 
#   spread(variable, percentage)



coi.pa.taxloc <- coi.sub.taxloc %>%
  select(-c(ID.match, Location, Tax)) %>%
  mutate_all(funs(case_when(. > 0 ~ 1,
                       TRUE ~ 0))) %>%
  add_column(ID.match = coi.sub.taxloc$ID.match) %>%
  select(ID.match, everything())

### run mds
coi.mds.taxloc <- metaMDS(coi.pa.taxloc[-1], k = 3, trymax = 1000, distance = "jaccard", engine = "monoMDS", autotransform =TRUE)
coi.mds.taxloc

###get values and plot in ggplot
coi.scores.taxloc <- as.tibble(coi.mds.taxloc$points)
coi.scores.taxloc$tax <- coi.sub.taxloc$Tax
coi.scores.taxloc$location <- coi.sub.taxloc$Location
coi.scores.taxloc$ID.match <- coi.sub.taxloc$ID.match

coi.scores.taxloc1 <- coi.scores.taxloc %>%
  unite("taxloc", c(tax, location), remove = F)


###do permanova
coi.pa.perm.taxloc <- adonis(coi.pa.taxloc[-1] ~ location * tax, data = coi.scores.taxloc1)
coi.pa.perm.taxloc

###do simper
coi.pa.sim.taxloc <- as.list(simper(coi.pa.taxloc[-1], coi.scores.taxloc1$taxloc))
simsum.taxloc <- summary(coi.pa.sim.taxloc)
top3.taxloc<-lapply(simsum.taxloc, `[`,1:3,)
otunames <- ldply(lapply(top3.taxloc, rownames)) %>%
  gather("comparison", "ID", V1, V2, V3) %>%
  arrange(.id)

top3long.taxloc <- plyr::ldply(top3.taxloc, data.frame) %>%
  arrange(.id) %>%
  select(.id) %>%
  add_column(ID = otunames$ID)

OTUcoords.taxloc <- as.data.frame(coi.mds.taxloc$species) %>%
  add_column(ID = rownames(.))

OTUtax <- coi.seqs[c(1:10)]

top3coords.taxloc <- top3long %>%
  left_join(OTUcoords.taxloc, by = "ID") %>%
  left_join(OTUtax, by = "ID") %>%
  mutate(taxID = case_when(pident >= 97 ~ paste(phylum, class, order, species, sep = " | "),
                           pident >= 95 ~ paste(phylum, class, order, sep = " | "),
                           pident >= 85 ~ paste(phylum, class, sep = " | "),
                           pident >= 75 ~ paste(phylum),
                           pident < 75 ~ "Unidentified")) %>%
  mutate(oMDS1 = 0,
         oMDS2 = 0) %>%
  select(-.id) %>%
  unique(.) %>%
  replace_na(list(taxID = "Chordata | Actinpterygii | Blenniiformes | Salarias fasciatus"))
#7 is arthropoda tantytarsus again
#12 is Salarias fasciatus

###create convex hulls function
convex_hull <- function(coi.scores.taxloc1) coi.scores.taxloc1[chull(coi.scores.taxloc1$MDS1, coi.scores.taxloc1$MDS2),] 

###run convex hulls on habitats
fish.hulls.taxloc <- ddply(coi.scores.taxloc1, "taxloc", convex_hull)

# ### set colors
taxcols <- c("gold2", "olivedrab4", "olivedrab2", "cyan4", "cyan2", "darkorchid4", "darkorchid2", "lightpink1", "royalblue2")

###plot mds results
# plot one species name
mds.pa.coi.taxloc <- ggplot(coi.scores.taxloc1, aes(x = MDS1, y = MDS2)) +
  #overlay convex hulls
  geom_polygon(data = fish.hulls.taxloc, aes(x = MDS1, y = MDS2,
                                         color = taxloc,
                                         group = taxloc), fill = "grey69",
               alpha = 0.1, lty = 1, lwd = 0.1) +
  # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
  #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
  #overlay point
  geom_point(size = 2, aes(color = taxloc, group = taxloc, shape = location)) +
  theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none")+
  scale_y_continuous(limits = c(-1.4,1.3), breaks = seq(-1,1,0.5)) +
  scale_x_continuous(limits = c(-1.1,1.6), breaks = seq(-1,1,0.5)) +
  scale_color_manual(values = taxcols) +
  scale_fill_manual(values = taxcols)

mds.pa.coi.taxloc

mds.top3.coi.taxloc <- ggplot(top3coords.taxloc, aes(x = MDS1, y = MDS2)) +
  geom_segment(mapping = aes(xend = oMDS1, yend = oMDS2), lwd = 0.2, lty = 2) +
  geom_point(size = 3, shape = 18) +
    geom_label_repel(aes(label = taxID), size = 2) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") +
  scale_y_continuous(limits = c(-1.4,1.3), breaks = seq(-1,1,0.5)) +
  scale_x_continuous(limits = c(-1.1,1.6), breaks = seq(-1,1,0.5)) 
mds.top3.coi.taxloc

mds.coi.taxloc.vec <- ggarrange(mds.pa.coi.taxloc, mds.top3.coi.taxloc, ncol = 1, nrow = 2)

ggsave("mds.pa.coi.taxloc.pdf", mds.coi.loc.vec, width = 10, height = 8, useDingbats = FALSE)
# 
# ### do taxa in Gulf of Oman only
# coi.sub.tax <- coi.sub %>%
#     filter(Location == "GoO")
# 
# # coi.rra <- coi.sub.tax %>%
# #   select(-c(Location, Tax)) %>%
# #   gather(variable, value, -ID.match) %>%
# #   group_by(ID.match) %>% 
# #   mutate(percentage = value/sum(value)) %>% 
# #   select(-value) %>% 
# #   spread(variable, percentage)
# 
# coi.pa.tax <- coi.sub.tax %>%
#   select(-c(ID.match, Location, Tax)) %>%
#   mutate_all(funs(case_when(. > 0 ~ 1,
#                        TRUE ~ 0))) %>%
#   add_column(ID.match = coi.sub.tax$ID.match) %>%
#   select(ID.match, everything())
# 
# ### run mds
# coi.mds.tax <- metaMDS(coi.pa.tax[-1], k = 3, trymax = 2000, distance = "jaccard", engine = "monoMDS", autotransform =TRUE)
# coi.mds.tax
# 
# ###get values and plot in ggplot
# coi.scores.tax <- as.tibble(coi.mds.tax$points)
# coi.scores.tax$tax <- coi.sub.tax$Tax
# coi.scores.tax$location <- coi.sub.tax$Location
# coi.scores.tax$ID.match <- coi.sub.tax$ID.match
# 
# coi.scores.tax1 <- coi.scores.tax %>%
#   unite("taxloc", c(tax, location), remove = F)
# 
# 
# ###create convex hulls function
# convex_hull <- function(coi.scores.tax1) coi.scores.tax1[chull(coi.scores.tax1$MDS1, coi.scores.tax1$MDS2),] 
# 
# ###run convex hulls on habitats
# fish.hulls.tax <- ddply(coi.scores.tax, "tax", convex_hull)
# 
# # ### set colors
# taxonlycols <- c("gold2", "olivedrab2", "cyan2", "darkorchid2", "lightpink1", "royalblue2")
# 
# ###plot mds results
# # plot one species name
# mds.pa.coi.tax <- ggplot(coi.scores.tax1, aes(x = MDS1, y = MDS2)) +
#   #overlay convex hulls
#   geom_polygon(data = fish.hulls.tax, aes(x = MDS1, y = MDS2,
#                                          color = tax,
#                                          group = tax), fill = "grey69",
#                alpha = 0.1, lty = 1, lwd = 0.1) +
#   # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
#   #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
#   #overlay point
#   geom_point(size = 2, aes(color = tax, group = tax), shape = 17) +
#   theme_bw() + theme(panel.grid.major = element_blank(), 
#                      panel.grid.minor = element_blank(),
#                      axis.title = element_text(size=14),
#                      axis.text.x = element_text(size = 14),
#                      axis.text.y = element_text(size = 14),
#                      legend.position = "none") +
#   #   scale_y_continuous(limits = c(-1.2,1.2), breaks = seq(-1,1,0.5)) +
#   # scale_x_continuous(limits = c(-1.2,1.4), breaks = seq(-1,1,0.5)) +
#   scale_color_manual(values = taxonlycols) +
#   scale_fill_manual(values = taxonlycols)

mds.coi.tax.vec <- ggarrange(mds.pa.coi.tax, mds.top3.coi.taxloc, ncol = 1, nrow = 2)

ggsave("mds.coi.tax.vec", mds.pa.coi.tax, width = 7, height = 10, useDingbats = FALSE)

coi.plots <- ggarrange(mds.coi.loc.vec, mds.coi.taxloc.vec, nrow = 1, ncol = 2)
coi.plots
ggsave("mds.coi.vec.pdf", coi.plots, width = 12, height = 12, useDingbats = FALSE)



###23S data
seqs23s <- read.csv(file = "UAE_23S.csv") %>%
  select(-c(UAE18862.1, UAE18400.1))
#create vector for column names 
cnames <- as.character(seqs23s$ESV)
sub23s <- seqs23s %>%
  #grab columns of fish gut specimens
  select(., contains("UAE18")) %>%
  rownames_to_column %>% 
  gather(var, value, -rowname) %>% 
  spread(rowname, value) %>%
  set_colnames(c("ID.match", cnames)) %>%
  join(guts.meta[c("Location", "Tax", "ID.match")], by = "ID.match") %>%
  select(ID.match, Location, Tax, everything()) %>% 
  mutate(rowsum = rowSums(.[4:3009]))

sub23s.loc <- sub23s %>%
  filter(Tax %in% c("ENNEVENT", "CORYANOM", "ECSEPULC"))

# coi.rra <- coi.sub.tax %>%
#   select(-c(Location, Tax)) %>%
#   gather(variable, value, -ID.match) %>%
#   group_by(ID.match) %>% 
#   mutate(percentage = value/sum(value)) %>% 
#   select(-value) %>% 
#   spread(variable, percentage)
# 


pa23s.loc <- sub23s.loc %>%
  select(-c(ID.match, Location, Tax)) %>%
  mutate_all(funs(case_when(. > 0 ~ 1,
                       TRUE ~ 0))) %>%
  add_column(ID.match = sub23s.loc$ID.match) %>%
  select(ID.match, everything())

### run mds
mds23s.loc <- metaMDS(pa23s.loc[-1], k = 3, trymax = 1000, distance = "jaccard", engine = "monoMDS", autotransform =TRUE)

###get values and plot in ggplot
scores23s.loc <- as.tibble(mds23s.loc$points)
scores23s.loc$tax <- sub23s.loc$Tax
scores23s.loc$location <- sub23s.loc$Location
scores23s.loc$ID.match <- sub23s.loc$ID.match

scores23s.loc1 <- scores23s.loc %>%
  unite("taxloc", c(tax, location), remove = F)


###do permanova
perm.23.loc <- adonis(pa23s.loc[-1] ~ location * tax, data = scores23s.loc1)
perm.23.loc

###do simper
pa.sim.23s.loc <- as.list(simper(pa23s.loc[-1], scores23s.loc1$taxloc))
simsum.23sloc <- summary(pa.sim.23s.loc)
top3.23s.loc<-lapply(simsum.23sloc, `[`,1,)
esvnames <- ldply(lapply(top3.23s.loc, rownames)) %>%
  gather("comparison", "ESV", V1) %>%
  arrange(.id)

top3long.23s.loc <- plyr::ldply(top3.23s.loc, data.frame) %>%
  arrange(.id) %>%
  select(.id) %>%
  add_column(ESV = esvnames$ESV)

ESVcoords.23s.loc <- as.data.frame(mds23s.loc$species) %>%
  add_column(ESV = rownames(.))

ESVtax <- seqs23s[c(1:9)]

top3coords.23s.loc <- top3long.23s.loc %>%
  left_join(ESVcoords.23s.loc, by = "ESV") %>%
  left_join(ESVtax, by = "ESV") %>%
  mutate(taxID = case_when(id >= 97 ~ paste(Phylum, Order, Species, sep = " | "),
                           id >= 95 ~ paste(Phylum, Order, sep = " | "),
                           id >= 85 ~ paste(Phylum, Order, sep = " | "),
                           id >= 75 ~ paste(Phylum),
                           id < 75 ~ "Unidentified")) %>%
  mutate(oMDS1 = 0,
         oMDS2 = 0) %>%
  select(-.id) %>%
  distinct(taxID, MDS1, MDS2, oMDS1, oMDS2) 


###create convex hulls function
convex_hull <- function(scores23s.loc1) scores23s.loc1[chull(scores23s.loc1$MDS1, scores23s.loc1$MDS2),] 

###run convex hulls on habitats
fish.hulls23s.loc <- ddply(scores23s.loc1, "taxloc", convex_hull)

# ### set colors
taxloccols <- c("olivedrab4", "olivedrab2", "cyan4", "cyan2", "darkorchid4", "darkorchid2")

###plot mds results
# plot one species name
mds.pa.23s.loc <- ggplot(scores23s.loc1, aes(x = MDS1, y = MDS2)) +
  #overlay convex hulls
  geom_polygon(data = fish.hulls23s.loc, aes(x = MDS1, y = MDS2,
                                         color = taxloc,
                                         group = taxloc), fill = "grey69",
               alpha = 0.1, lty = 1, lwd = 0.1) +
  # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
  #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
  #overlay point
  geom_point(size = 2, aes(color = taxloc, group = taxloc, shape = location)) +
  theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") +
  scale_y_continuous(limits = c(-2.5,1.2), breaks = seq(-2,1,0.5)) +
  scale_x_continuous(limits = c(-1.8,1.2), breaks = seq(-2,1,0.5)) +
  scale_color_manual(values = taxloccols) +
  scale_fill_manual(values = taxloccols)

mds.pa.23s.loc
ggsave("mds.pa.23s.loc.pdf", mds.pa.23s.loc, width = 10, height = 8, useDingbats = FALSE)

mds.top3.23s.loc <- ggplot(top3coords.23s.loc, aes(x = MDS1, y = MDS2)) +
  geom_segment(mapping = aes(xend = oMDS1, yend = oMDS2), lwd = 0.2, lty = 2) +
  geom_point(size = 3, shape = 18) +
    geom_label_repel(aes(label = taxID), size = 1.5, segment.size = 0.2) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") + 
  scale_y_continuous(limits = c(-2.5,1.2), breaks = seq(-2,1,0.5)) +
  scale_x_continuous(limits = c(-1.8,1.2), breaks = seq(-2,1,0.5))
mds.top3.23s.loc

mds.23s.loc.vec <- ggarrange(mds.pa.23s.loc, mds.top3.23s.loc, ncol = 1, nrow = 2)
mds.23s.loc.vec
ggsave("mds.23s.loc.vec.pdf", mds.23s.loc.vec, width = 7, height = 10, useDingbats = FALSE)




### try bringing in the other taxa
sub23s.taxloc <- sub23s 

pa23s.taxloc <- sub23s.taxloc %>%
  select(-c(ID.match, Location, Tax)) %>%
  mutate_all(funs(case_when(. > 0 ~ 1,
                       TRUE ~ 0))) %>%
  add_column(ID.match = sub23s.taxloc$ID.match) %>%
  select(ID.match, everything())

### run mds
mds23s.taxloc <- metaMDS(pa23s.taxloc[-1], k = 3, trymax = 1000, distance = "jaccard", engine = "monoMDS", autotransform =TRUE)

###get values and plot in ggplot
scores23s.taxloc <- as.tibble(mds23s.taxloc$points)
scores23s.taxloc$tax <- sub23s.taxloc$Tax
scores23s.taxloc$location <- sub23s.taxloc$Location
scores23s.taxloc$ID.match <- sub23s.taxloc$ID.match

scores23s1.taxloc <- scores23s.taxloc %>%
   unite("taxloc", c(tax, location), remove = F)

###do permanova
perm.23.taxloc <- adonis(pa23s.taxloc[-1] ~ location * tax, data = scores23s1.taxloc)
perm.23.taxloc

###do simper
pa.sim.23s.taxloc <- as.list(simper(pa23s.taxloc[-1], scores23s1.taxloc$taxloc))
simsum.23staxloc <- summary(pa.sim.23s.taxloc)
top3.23s.taxloc<-lapply(simsum.23staxloc, `[`,1,)
esvnames <- ldply(lapply(top3.23s.taxloc, rownames)) %>%
  gather("comparison", "ESV", V1) %>%
  arrange(.id)

top3long.23s.taxloc <- plyr::ldply(top3.23s.taxloc, data.frame) %>%
  arrange(.id) %>%
  select(.id) %>%
  add_column(ESV = esvnames$ESV)

ESVcoords.23s.taxloc <- as.data.frame(mds23s.taxloc$species) %>%
  add_column(ESV = rownames(.))

ESVtax <- seqs23s[c(1:9)]

top3coords.23s.taxloc <- top3long.23s.taxloc %>%
  left_join(ESVcoords.23s.taxloc, by = "ESV") %>%
  left_join(ESVtax, by = "ESV") %>%
  mutate(taxID = case_when(id >= 97 ~ paste(Phylum, Order, Species, sep = " | "),
                           id >= 95 ~ paste(Phylum, Order, sep = " | "),
                           id >= 85 ~ paste(Phylum, Order, sep = " | "),
                           id >= 75 ~ paste(Phylum),
                           id < 75 ~ "Unidentified")) %>%
  mutate(oMDS1 = 0,
         oMDS2 = 0) %>%
  select(-.id) %>%
  distinct(taxID, MDS1, MDS2, oMDS1, oMDS2) 



###create convex hulls function
convex_hull <- function(scores23s1.taxloc) scores23s1.taxloc[chull(scores23s1.taxloc$MDS1, scores23s1.taxloc$MDS2),] 

###run convex hulls on habitats
fish.hulls23s.taxloc <- ddply(scores23s1.taxloc, "taxloc", convex_hull)

# ### set colors
taxcols <- c("gold2", "olivedrab4", "olivedrab2", "cyan4", "cyan2", "darkorchid4", "darkorchid2", "lightpink1", "royalblue2")

###plot mds results
# plot one species name
mds.pa.23s.taxloc <- ggplot(scores23s1.taxloc, aes(x = MDS1, y = MDS2)) +
  #overlay convex hulls
  geom_polygon(data = fish.hulls23s.taxloc, aes(x = MDS1, y = MDS2,
                                         color = taxloc,
                                         group = taxloc), fill = "grey69",
               alpha = 0.1, lty = 1, lwd = 0.1) +
  # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
  #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
  #overlay point
  geom_point(size = 2, aes(color = taxloc, group = taxloc, shape = location)) +
  theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") +
  scale_y_continuous(limits = c(-2.1,1.3), breaks = seq(-2,1,0.5)) +
  scale_x_continuous(limits = c(-2.3,1), breaks = seq(-2,1,0.5)) +
  scale_color_manual(values = taxcols) +
  scale_fill_manual(values = taxcols)

mds.pa.23s.taxloc
ggsave("mds.pa.23s.taxloc.pdf", mds.pa.23s.taxloc, width = 10, height = 8, useDingbats = FALSE)


mds.top3.23s.taxloc <- ggplot(top3coords.23s.taxloc, aes(x = MDS1, y = MDS2)) +
  geom_segment(mapping = aes(xend = oMDS1, yend = oMDS2), lwd = 0.2, lty = 2) +
  geom_point(size = 3, shape = 18) +
    geom_label_repel(aes(label = taxID), size = 1.5, segment.size = 0.2) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=10),
                     axis.text.x = element_text(size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.position = "none") +
  scale_y_continuous(limits = c(-2.1,1.3), breaks = seq(-2,1,0.5)) +
  scale_x_continuous(limits = c(-2.3,1), breaks = seq(-2,1,0.5)) 
mds.top3.23s.taxloc

mds.23s.taxloc.vec <- ggarrange(mds.pa.23s.taxloc, mds.top3.23s.taxloc, ncol = 1, nrow = 2)
mds.23s.taxloc.vec
ggsave("mds.23s.loc.vec.pdf", mds.23s.loc.vec, width = 7, height = 10, useDingbats = FALSE)

plots23s <- ggarrange(mds.23s.loc.vec, mds.23s.taxloc.vec, nrow = 1, ncol = 2)

ggsave("plots23svectors.pdf", plots23s, width = 12, height = 12, useDingbats = FALSE)

############
### do taxa in GoO only
# sub23s.tax <- sub23s %>%
#   filter(Location == "GoO")
# 
# pa23s.tax <- sub23s.tax %>%
#   select(-c(ID.match, Location, Tax)) %>%
#   mutate_all(funs(case_when(. > 0 ~ 1,
#                        TRUE ~ 0))) %>%
#   add_column(ID.match = sub23s.tax$ID.match) %>%
#   select(ID.match, everything())
# 
# ### run mds
# mds23s.tax <- metaMDS(pa23s.tax[-1], k = 3, trymax = 1000, distance = "jaccard", engine = "monoMDS", autotransform =TRUE)
# 
# ###get values and plot in ggplot
# scores23s.tax <- as.tibble(mds23s.tax$points)
# scores23s.tax$tax <- sub23s.tax$Tax
# scores23s.tax$location <- sub23s.tax$Location
# scores23s.tax$ID.match <- sub23s.tax$ID.match
# 
# scores23s1.tax <- scores23s.tax %>%
#    unite("taxloc", c(tax, location), remove = F)
# 
# 
# ###create convex hulls function
# convex_hull <- function(scores23s1.tax) scores23s1.tax[chull(scores23s1.tax$MDS1, scores23s1.tax$MDS2),] 
# 
# ###run convex hulls on habitats
# fish.hulls23s.tax <- ddply(scores23s1.tax, "tax", convex_hull)
# 
# # ### set colors
# taxonlycols <- c("gold2", "olivedrab2", "cyan2", "darkorchid2", "lightpink1", "royalblue2")
# 
# ###plot mds results
# # plot one species name
# mds.pa.23s.tax <- ggplot(scores23s1.tax, aes(x = MDS1, y = MDS2)) +
#   #overlay convex hulls
#   geom_polygon(data = fish.hulls23s.tax, aes(x = MDS1, y = MDS2,
#                                          color = tax,
#                                          group = tax), fill = "grey69",
#                alpha = 0.1, lty = 1, lwd = 0.1) +
#   # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
#   #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
#   #overlay point
#   geom_point(size = 2, aes(color = tax, group = tax), shape = 17) +
#   theme_bw() + theme(panel.grid.major = element_blank(), 
#                      panel.grid.minor = element_blank(),
#                      axis.title = element_text(size=10),
#                      axis.text.x = element_text(size = 10),
#                      axis.text.y = element_text(size = 10),
#                      legend.position = "none") +
#   #   scale_y_continuous(limits = c(-1.2,1.2), breaks = seq(-1,1,0.5)) +
#   # scale_x_continuous(limits = c(-1.2,1.4), breaks = seq(-1,1,0.5)) +
#   scale_color_manual(values = taxonlycols) +
#   scale_fill_manual(values = taxonlycols)
# 
# mds.pa.23s.tax
# ggsave("mds.pa.23s.tax.pdf", mds.pa.23s.tax, width = 10, height = 8, useDingbats = FALSE)
# 
# plots23s <- ggarrange(mds.pa.23s.loc, mds.pa.23s.taxloc, mds.pa.23s.tax, nrow = 1, ncol = 3)
# plots23s
# 
# ggsave("plots23s.pdf", plots23s, width = 10, height = 8, useDingbats = FALSE)
```


