---
title: "UAE18 crypto communities"
author: "Simon J Brandl"
date: "11/22/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#load packages
library(plyr)
library(tidyverse)
library(vegan)
library(nlme)
library(lme4)
library(ggpubr)
library(ggrepel)
library(colorRamps)
```

```{r}
#load datasets
comms <- read.csv(file = "UAE18_RawData_Comms.csv")
ctdat <- read.csv(file = "UAE_CT.csv")
comms$Genspe <- paste(substr(comms$Genus, 0,3), comms$Species, sep = ". ")
ctdat$Genspe <- paste(substr(ctdat$Genus, 0,3), ctdat$Species, sep = ". ")
ctdat <- ctdat %>% mutate(Distribution = case_when(Tax == "ECSEPULC" ~ "AG+GoM",
                                         Tax == "CORYANOM" ~ "AG+GoM",
                                         Tax == "ENNEVENT" ~ "AG+GoM",
                                         Tax == "HELCFUSC" ~ "GoM",
                                         Tax == "HETEVULG" ~ "GoM",
                                         Tax == "EVIOGUTT" ~ "GoM"))
ctmax <- subset(ctdat, ctdat$Ctmax != "NA")
ctmin <- subset(ctdat, ctdat$Ctmin != "NA")
```

```{r pressure, echo=FALSE}
#start with community analyses
# 1. compare abundance, biomass, diversity
# 2. compare community composition
# calculate surface area for each bommie 
# radius first (2*curved surface length/2*pi)
comms$radius <- (2*comms$Dimension)/(2*pi)
# surface area (4*pi*radius^2)/2 and divide by 10000 for square meters
comms$SA <- ((4*pi*comms$radius^2)/2)/10000

###get biomass and diversity estimates for Arabian Gulf and Gulf of Oman
comm_means <- comms %>% group_by(Location, Site, Sitename, Sitenumber) %>% summarize(Biomass = sum(W), Abundance = n(), Speciesrichness = length(unique(Genspe)), SA = mean(SA))
comm_means$Density <- comm_means$Abundance/comm_means$SA
comm_means$Biomass_per_m2 <- comm_means$Biomass/comm_means$SA

########################EVIOTA
eviota.abu <- comms %>%
  filter(Location == "GoO",
         Genus == "Eviota") %>%

#run GLM with abundance data and offset for surface area sampled
# abundance.model <- glmer.nb()

# plot density data
density_plot <- ggplot(comm_means, aes(x = Location, y = Density, color = Location))+
  geom_jitter(aes(fill = Location), alpha = 0.5, width = 0.1, color = "black", shape = 23, size = 3) +
  stat_summary(fun.data = "mean_cl_boot", size = 1) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                     axis.title = element_text(size=14),
                     axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     legend.position="none") +
  scale_color_manual(values = c("forestgreen", "gray5")) +
  scale_fill_manual(values = c("forestgreen", "gray5")) +
  scale_y_continuous(limits = c(0, 45), breaks = seq(0,45,5))+
  xlab(NULL)
density_plot

# plot species richness data
speciesrichnessplot <- ggplot(comm_means, aes(x = Location, y = Speciesrichness, color = Location))+
  geom_jitter(aes(fill = Location), alpha = 0.5, width = 0.1, color = "black", shape = 23, size = 3) +
  stat_summary(fun.data = "mean_cl_boot", size = 1) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                     axis.title = element_text(size=14),
                     axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     legend.position="none") +
  scale_color_manual(values = c("forestgreen", "gray5")) +
  scale_fill_manual(values = c("forestgreen", "gray5")) +
  scale_y_continuous(limits = c(0, 30), breaks = seq(0,30,5))+
  xlab(NULL)
speciesrichnessplot

# plot species richness data
biomassplot <- ggplot(comm_means, aes(x = Location, y = Biomass_per_m2, color = Location))+
  geom_jitter(aes(fill = Location), alpha = 0.5, width = 0.1, color = "black", shape = 23, size = 3) +
  stat_summary(fun.data = "mean_cl_boot", size = 1) +
    theme_bw() + theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                     axis.title = element_text(size=14),
                     axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14),
                     legend.position="none") +
  scale_color_manual(values = c("forestgreen", "gray5")) +
  scale_fill_manual(values = c("forestgreen", "gray5")) +
  scale_y_continuous(limits = c(0, 35), breaks = seq(0,35,5)) +
  xlab(NULL)
biomassplot

# stitch three plots together
comm_plots <- ggarrange(speciesrichnessplot, density_plot, biomassplot, nrow = 3, ncol = 1)
comm_plots
ggsave("comm_plots.pdf", plot = comm_plots, width = 3, height = 8)

# 2. Communuity composition
# create variable of 1s for count
comms$count = 1
comms_wide <- comms %>% 
  group_by(Location, Site, Sitenumber, Genspe) %>%
  summarize(totaln = sum(count)) %>%
  spread(Genspe, totaln, fill = 0) 

###run MDS
comp_mds <- metaMDS(comms_wide[-c(1:3)], k = 2, metric = "bray", trymax = 1000)
comp_mds
###get values and plot in ggplot
site.scores <- as.tibble(scores(comp_mds))
site.scores$Location <- comms_wide$Location
site.scores$Site <- comms_wide$Site
site.scores$Sitenumber <- comms_wide$Sitenumber
site.scores <- site.scores %>% inner_join(comm_means)


###create convex hulls function
convex_hull <- function(site.scores) site.scores[chull(site.scores$NMDS1, site.scores$NMDS2),] 

###run convex hulls on habitats
location_hulls <- ddply(site.scores, "Location", convex_hull)


###create vector with habitat names in center of convex hulls
location_centers <- location_hulls %>% group_by(Location) %>% summarize(NMDS1 = mean(NMDS1), NMDS2 = mean(NMDS2))

###plot mds results
# plot one species name
comp_plot <- ggplot(site.scores, aes(x = NMDS1, y = NMDS2)) +
  #overlay convex hulls
  geom_polygon(data = location_hulls, aes(x = NMDS1, y = NMDS2, 
                                         fill = Location, 
                                         group = Location), 
               alpha = 0.4, lty = 1, lwd = 0.1, color = "black") +
  #overlay points
  geom_point(aes(color = Location, group = Location, fill = Location,
                             shape = Site, size = Speciesrichness)) +
  theme_bw()+
  theme(legend.position = "right") +
  scale_color_manual(values = c("forestgreen", "gray5")) +
  scale_fill_manual(values = c("forestgreen", "gray5")) +
  scale_shape_manual(values = c(8, 21:25))

comp_plot
ggsave("comp_plot.pdf", plot = comp_plot, width = 7, height = 5, useDingbats=FALSE)

###check size structure
size_str_plot <- ggplot(comms, aes(x = log10(W), fill = Location)) +
  geom_density(alpha = 0.2, adjust = 5) +
  facet_grid(Location~.) +
  scale_color_manual(values = c("forestgreen", "gray5")) +
  scale_fill_manual(values = c("forestgreen", "gray5"))
size_str_plot
```

``` {r}
# ct max and ctmin
ctmax
ctmaxmod <- lm(Ctmax ~ Distribution, data = ctmax)
summary(ctmaxmod)
ctmax_sum <- ctmax %>% group_by(Distribution) %>% summarize(mean = mean(Ctmax), sd = sd(Ctmax), n = n()) %>%
  mutate(se = sd / sqrt(n),
         lci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         uci = mean + qt(1 - (0.05 / 2), n - 1) * se)

ctmaxplot <- ggplot(data = ctmax)+
  geom_jitter(aes(x = Genspe, y = Ctmax, color = Location, fill = Location, shape = Distribution), alpha = 0.7, width = 0.1, color = "black") +
  geom_rect(data = ctmax_sum, aes(ymin =  lci, ymax = uci, xmin = 0, xmax = 7), alpha = 0.1) +
  geom_hline(data = ctmax_sum, aes(yintercept = mean), lty = c(2,3)) +
  stat_summary(aes(x = Genspe, y = Ctmax, color = Location, fill = Location, shape = Distribution), fun.data = "mean_cl_boot", size = 0.9, color = "black") +
    theme_bw() + theme(legend.position="none",
                       axis.text.x = element_text(angle = 45, hjust = 1, face = "italic", size = 6),
                       axis.title.x=element_blank()) +
  scale_color_manual(values = c("forestgreen", "gray5", "black")) +
  scale_fill_manual(values = c("forestgreen", "gray5")) +
  scale_shape_manual(values = c(22,23)) +
  scale_y_continuous(limits = c(35,39), breaks = seq(35,39,0.5))+
  ylab("Critical thermal maximum (ยบ Celsius)")
ctmaxplot


ctminmod <- lm(Ctmin ~ Distribution, data = ctmin)
summary(ctminmod)
ctmin_sum <- ctmin %>% group_by(Location) %>% summarize(mean = mean(Ctmin), sd = sd(Ctmin), n = n()) %>%
  mutate(se = sd / sqrt(n),
         lci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         uci = mean + qt(1 - (0.05 / 2), n - 1) * se)
ctminplot <- ggplot(data = ctmin)+
  geom_jitter(aes(x = Genspe, y = Ctmin, color = Location, fill = Location, shape = Distribution), alpha = 0.7, width = 0.1, color = "black") +
  geom_rect(data = ctmin_sum, aes(ymin =  lci, ymax = uci, xmin = 0, xmax = 7), alpha = 0.1) +
  geom_hline(data = ctmin_sum, aes(yintercept = mean), lty = c(2,3)) +
  stat_summary(aes(x = Genspe, y = Ctmin, color = Location, fill = Location, shape = Distribution), fun.data = "mean_cl_boot", size = 0.9, color = "black") +
    theme_bw() + theme(legend.position="none",
                       axis.text.x = element_text(angle = 45, hjust = 1, face = "italic", size = 6),
                       axis.title.x=element_blank()) +
  scale_color_manual(values = c("forestgreen", "gray5", "black")) +
  scale_fill_manual(values = c("forestgreen", "gray5")) +
  scale_shape_manual(values = c(22,23)) +
  scale_y_continuous(limits = c(10,14), breaks = seq(10,14,0.5)) +
  ylab("Critical thermal minimum (ยบ Celsius)")
ctminplot

ctplots <- ggarrange(ctmaxplot, ctminplot, nrow = 2, ncol = 1)

ggsave("ct_plot.pdf", plot = ctplots, width = 7, height = 8, useDingbats=FALSE)
```

``` {r}
# map of study region

####FIGURE 1B####
library(ggmap)

world <- map_data("world")
world_sub <- subset(world, world$long >= 50 & world$long <= 60 & world$lat >= 20 & world$lat <= 30)

country_names <- world_sub %>% group_by(region) %>% summarize(lat = mean(lat), long = mean(long))

UAEcoord <- comms[c(2,3,20,21)]
UAEcoord_unique <- unique(UAEcoord)

middle.east <- ggplot() +
  geom_map(data = world_sub, map = world, aes(x = long, y = lat, map_id = region), fill = "grey69", color = "grey46", lwd = 0.1) +
  geom_point(data = UAEcoord_unique, aes(x = long, y = Lat, color = Location), size = 3, alpha = 1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  annotate("text", label = "United Arab Emirates", x = 54, y = 23.5, size = 3, colour = "black") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east
ggsave("middle_east.pdf", plot = middle.east, width = 6, height = 5, useDingbats=FALSE)

UAElarge <- subset(world, world$long >= -10 & world$long <= 120 & world$lat >= 0 & world$lat <= 70)

middle.east.large <- ggplot() +
  geom_map(data = UAElarge, map = world, aes(x = long, y = lat, map_id = region), fill = "grey92", color = "grey46", lwd = 0.1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east.large
ggsave("middle_east_large.pdf", plot = middle.east.large, width = 6, height = 4, useDingbats=FALSE)


UAEmid <- subset(world, world$long >= 30 & world$long <= 80 & world$lat >= 10 & world$lat <= 40)

middle.east.mid <- ggplot() +
  geom_map(data = UAEmid, map = world, aes(x = long, y = lat, map_id = region), fill = "grey92", color = "grey46", lwd = 0.1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east.mid
ggsave("middle_east_large.pdf", plot = middle.east.large, width = 6, height = 4, useDingbats=FALSE)

america <- subset(world, world$region == "United States of America" & world$region == "Canada")

middle.east.mid <- ggplot() +
  geom_map(data = UAEmid, map = world, aes(x = long, y = lat, map_id = region), fill = "grey92", color = "grey46", lwd = 0.1) +
  xlab("Longitude") + ylab("Latitude") +
  # scale_x_continuous(limits = c(-180, 180), breaks = seq(-180,180, 30)) +
  # scale_y_continuous(limits = c(-60, 75), breaks = seq(-60, 75, 15)) +
  # geom_hline(yintercept = 0, lty = 2, led = 0.1, color = "grey") +
  scale_color_manual(name = "Location", values = c("#00B0F0", "#ed68fc")) +
  theme_bw() + theme(axis.title = element_text(size=10),
                     axis.text.x = element_text(
                       size = 10),
                     axis.text.y = element_text(size = 10),
                     legend.text=element_text(size=10),
                     legend.title = element_text(size = 10, face = "bold"),
                     panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                     legend.position = c(0.5, 0.9),
                     legend.direction = "horizontal",
                     legend.background = element_rect(fill="white", color = "black", size=0.2))

middle.east.mid
```

```{r}
### gut content metabarcoding data
detach("package:MASS", unload=TRUE)
guts.meta <- read.csv(file = "UAE_Metabarcoding.csv")
coi.seqs <- read.csv(file = "UAE_COI.csv")
#create vector for column names 
cnames <- as.character(coi.seqs$ID)
coi.sub <- coi.seqs[c(19:106)] %>%
  #grab columns of fish gut specimens
  rownames_to_column %>% 
  gather(var, value, -rowname) %>% 
  spread(rowname, value) %>%
  set_colnames(c("ID.match", cnames)) %>%
  join(guts.meta[c("Location", "Tax", "ID.match")], by = "ID.match") %>%
  select(-c(OTU_1, OTU_2, OTU_3, OTU_4, OTU_5, OTU_6)) %>%
  select(ID.match, Location, Tax, everything()) 

coi.rra <- coi.sub %>%
  select(-c(Location, Tax)) %>%
  gather(variable, value, -ID.match) %>%
  group_by(ID.match) %>% 
  mutate(percentage = value/sum(value)) %>% 
  select(-value) %>% 
  spread(variable, percentage)

coi.pa <- coi.sub %>%
    select(-c(ID.match, Location, Tax)) %>%
  mutate_all(funs(case_when(. > 0 ~ 1,
                       TRUE ~ 0)))
### run mds
coi_mds <- metaMDS(coi.pa, k = 2, trymax = 100, distance = "jaccard")
coi_mds

###get values and plot in ggplot
coi.scores <- as.tibble(coi_mds$points)
coi.scores$tax <- coi.sub$Tax
coi.scores$location <- coi.sub$Location
coi.scores$ID.match <- coi.sub$ID.match

coi.scores1 <- coi.scores %>%
  filter(tax %in% c("ENNEVENT", "ECSEPULC", "EVIOGUTT", "HETEVULG", "ANTESPEA"))


###create convex hulls function
convex_hull <- function(coi.scores1) coi.scores1[chull(coi.scores1$MDS1, coi.scores1$MDS2),] 

###run convex hulls on habitats
fish_hulls <- ddply(coi.scores1, "tax", convex_hull)

### set colors
taxsymbols <- c()

###plot mds results
# plot one species name
fishgut_mdsplot <- ggplot(coi.scores1, aes(x = MDS1, y = MDS2)) +
  #overlay convex hulls
  geom_polygon(data = fish_hulls, aes(x = MDS1, y = MDS2,
                                         fill = tax,
                                         group = tax),
               alpha = 0.3, lty = 1, lwd = 0.1) +
  # stat_ellipse(data = fish.scores1, aes(x = MDS1, y = MDS2, group = species),
  #              alpha = 1, lty = 1, lwd = 0.3, level = 0.50) +
  #overlay point
  geom_point(size = 2, aes(color = tax, group = tax, shape = location)) +
  theme_bw() + theme(panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     axis.title = element_text(size=14),
                     axis.text.x = element_text(size = 14),
                     axis.text.y = element_text(size = 14))
  #   scale_y_continuous(limits = c(-1.2,1.2), breaks = seq(-1,1,0.5)) +
  # scale_x_continuous(limits = c(-1.2,1.4), breaks = seq(-1,1,0.5)) +
  # scale_color_manual(values = fishcolors) +
  # scale_fill_manual(values = fishcolors)

fishgut_mdsplot
ggsave("mdsplot.pdf", fishgut_mdsplot, width = 10, height = 10, useDingbats = FALSE)

```


